#!/bin/bash
INFRA_VLAN=4093

ENCAP_IFACE=vxlan0
VMM_POLICY=OpenStack
AGENT_HOSTNAME=<%= @spec.name %>-<%= @spec.id %>
UPLINK_IFACE=eth1.$INFRA_VLAN

AGENT_CONF=/etc/opflex-agent-ovs/conf.d/agent_ovs.conf

RUN_DIR=/var/vcap/sys/run/agent-ovs
PIDFILE=${RUN_DIR}/pid
MCAST_PIDFILE=${RUN_DIR}/mcast.pid
LOG_DIR=/var/vcap/sys/log/agent-ovs
LOG_FILE=$LOG_DIR/agent-ovs.log
MCAST_LOG_FILE=$LOG_DIR/mcast-daemon.log

mkdir -p $LOG_DIR
mkdir -p $RUN_DIR

exec 2>&1
exec >> $LOG_FILE

case $1 in

  start)
    echo "--- Starting agent-ovs, pid $$ at `date` ---"
    echo "Running as `id`"

    dpkg -s agent-ovs 2> /dev/null | grep -c 'Status:.*installed' > /dev/null
    if [ ! $? -eq 0 ]; then
       echo "agent-ovs package not installed"

       boost_pkg='libboost-system1.54.0 libboost-chrono1.54.0 libboost-filesystem1.54.0 libboost-iostreams1.54.0 libboost-program-options1.54.0 libboost-random1.54.0 libboost-thread1.54.0'
       echo "Installing $boost_pkg"
       apt-get install $boost_pkg

       pushd /var/vcap/packages/agent-ovs/
       for p in http://launchpadlibrarian.net/173842835/libnl-nf-3-200_3.2.24-2_amd64.deb http://launchpadlibrarian.net/173842830/libnl-3-200_3.2.24-2_amd64.deb http://launchpadlibrarian.net/173842836/libnl-route-3-200_3.2.24-2_amd64.deb http://launchpadlibrarian.net/173842833/libnl-genl-3-200_3.2.24-2_amd64.deb
       do
          echo "Downloading $p"
          wget -N $p
       done
       popd

       dpkg -i /var/vcap/packages/agent-ovs/*.deb
       service agent-ovs stop
       service mcast-daemon stop
    fi

    if [ ! -f $AGENT_CONF ]
    then
       echo "Creating agent-ovs config file"
       sed -e "s/VMM_POLICY/$VMM_POLICY/g" \
           -e "s/HOSTNAME/$AGENT_HOSTNAME/g" \
           -e "s/ENCAP_IFACE/$ENCAP_IFACE/g" \
           -e "s/UPLINK_IFACE/$UPLINK_IFACE/g" \
           -e "s/UPLINK_VLAN/$INFRA_VLAN/g" </var/vcap/jobs/agent-ovs/config/agent-ovs.conf.template >agent-ovs.conf
       mv agent-ovs.conf $AGENT_CONF
fi

    # Launch mcast-daemon in the backgroud
    /usr/bin/mcast_daemon 2>&1 >>$MCAST_LOG_FILE &
    echo $! > $MCAST_PIDFILE

    echo $$ > $PIDFILE
    exec /usr/bin/agent_ovs -c /etc/opflex-agent-ovs/opflex-agent-ovs.conf \
       -c /etc/opflex-agent-ovs/conf.d \
       2>&1 >>$LOG_FILE

    ;;

  stop)
    echo "--- Stopping agent-ovs at `date` ---"

    kill -9 `cat $PIDFILE` || true
    rm -f $PIDFILE

    kill -9 `cat $MCAST_PIDFILE` || true
    rm -f $MCAST_PIDFILE

    ;;

  *)
    echo "Usage: ctl {start|stop}" ;;

esac

